<!DOCTYPE html>
<html>
<head>

<!-- License: https://github.com/paulrouget/dzslides 
Code is from this project.
License is permissive for changes. (Public Domain)
-->

<meta charset="utf-8">
<title>  Using A Blockchain to Prevent Product Counterfeiting </title>

<style>
#container {
	margin: 0px auto;
	width: 254px;
	height: 189px;
	border: 1px #222 solid;
	position: absolute;
	top: 1500px;
	left: 5000px;
}
#videoElement {
	width: 250px;
	height: 185px;
	background-color: #666;
}

/* style="top:375px;left:50px;"			- left bottom - slide 1 		*/
/* style="top:365px;left:507px;"		- right - mid  - slide 2 		*/
/* style="top:150px;left:507px;"		- right - mid  - slide 3 		*/
/* style="top:365px;left:507px;"		- right - mid  - slide 4 		*/

.red {
	color:red;
}

</style>

</head>
</head>
<body>

<header>
	<span style="height:30px;padding-right:5px;position:relative;top:5px;"> University of Wyoming: Department of Computer Science </span>
	<img height="30" style="padding-top:5px;float:right;" src="./img/UWabbreviated_H_CompSci_gold.jpg">
	<div id="container" style="top:375px;left:507px;">
		<video autoplay="true" id="videoElement">
		
		</video>
	</div>
</header>

<footer>by Prof. Philip Schlump&nbsp;
</footer>
















<!--

Copyrigyht (C) University of Wyoming, 2021.
By Prof Philip Schlump.

=========================================================================

-->


<link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
<!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
<script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script>
<style>
.video-js {
	width: 100%;
	height: 678px;
}
</style>



<!-- This is the first slide -->

<section>
    <h2 style="padding-top:80px;" >  Building Blockchain inside PostgreSQL </h2>
	<div style="width:100%">
		<img style="padding-left:70px;float-left;padding-top:20px;" height="150" src="img/logo_mod.png">
	</div>
    <footer>
			PostgreSQL International Conference <br>
			Prof. Philip Schlump <br>
           University of Wyoming <br>
           Department of Computer Science <br>
		   Tue Apr 20, 2021 <br>
	 </footer>
</section>

<!-- 2 -->
<section>
	<p>
		<ol>
			<li> Overview </li>
			<li> What is a blockchian. </li>
			<li> An approach Simple Signed proof of Immutable Data </li>
			<li> Proof of Signature. </li>
			<li> Shared Data (multi-node). </li>
			<li> Where our current efforts are at. </li>
		<ol>
	</p>
</section>


<!-- 3 -->
<section>
	<h3> Overview : What is a Blockchain </h3>
		<ul>
			<li> What is a blockchain? </li>
			<li> All the hype </li>
			<li> Underling system below cryptocurrencies </li>
			<li> Used for the transfer of assets: NFTs </li>
			<li> What can it really do? </li>
		</ul>
</section>

<!-- 4 -->
<section>
	<h3> Overview : Useful Features of Blockchain </h3>
		<ul>
			<li> Immutable Data </li>
			<li> Shared Data </li>
		</ul>
</section>

<!-- 5 -->
<section>
	<h3> Overview : Kinds of Blockchains </h3>
		<ul>
			<li> Private </li>
			<li> Permissioned </li>
			<li> Public </li>
		</ul>
</section>

<!-- 6 -->
<section>
	<h3> Overview : Consensus </h3>
		<ul>
			<li> 1st Generation Consensus: Proof of Work Bitcoin, Eth v.1.x </li>
			<li> 2nd Gen. Proof of Stake: Cardano., Eth v.2.x </li>
			<li> 2nd Gen. Proof of Authority: This presentation today </li>
			<li> 3rd Gen. Honey-Badger BFT, Difinity (Berkley) </li>
		</ul>
</section>

<!-- 7 -->
<section>
	<h3> Overview : Why a Blockchain Matters </h3>
		<ul>
			<li> Secure Transfer of Tokens and Ownership </li>
			<li> Strong Authentication </li>
		</ul>
</section>

<!-- =========================================================== Approach 1 =========================================================== -->

<!-- 8 -->
<section>
	<h3> An Approach: Requirements (single node) </h3>
		<ul>
			<li> Post data </li>
			<li> Immutable Data </li>
			<li> Triggers + Hash </li>
		</ul>
</section>

<!-- 9 -->
<!-- code at this point - Trigger / Table / pub-sub / Go -->
<section>
<pre style="font-size:14px;">
 1: CREATE TABLE bk_block (
 2:     id                uuid DEFAULT uuid_generate_v4() not null
                             primary key,
 3:     seq               serial not null,
 4:     data              text not null,
 5:     hash_of_this      text not null,
 6:     prev_block_hash   text default '*' not null,
 7:     prev_block_id     uuid not null,
 8:     created           timestamp default current_timestamp not null
 9: );
10: 
11: create unique index bk_block_u1 on bk_block ( hash_of_this );
12: create index bk_block_p1 on bk_block ( created );
13: create index bk_block_p2 on bk_block ( prev_block_id );
14: create index bk_block_p3 on bk_block ( prev_block_hash );
</pre>
</section>

<!-- 10 -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION bk_block_tg() RETURNS trigger AS $$
 2: DECLARE
 3:    l_seq_id bigint;
 4:    l_id text;
 5:    l_hash text;
 6: BEGIN
 7:     IF tg_op = 'UPDATE' or tg_op = 'DELETE' THEN
 8:       RAISE EXCEPTION 'Can not UPDATE or DELETE from '
              USING ERRCODE='20808';
 9:         RETURN NULL;   -- Prevent All Updtes/Deletes
10:     ELSIF tg_op = 'INSERT' THEN
11:       NEW.hash_of_this = digest(CONCAT(NEW.data,
             NEW.prev_block_hash,NEW.hash_of_this,
             (NEW.prev_block_id::text)), 'sha256');
12:       IF new.id = 'e9d963e1-d2a2-4e35-8c37-22742008bce4'::uuid
13:          and NEW.data = 'genesis row' THEN
14:          NEW.prev_block_hash = NEW.hash_of_this;
15:          NEW.prev_block_id = NEW.id;
16:       ELSE
17:          select  "id", "hash_of_this" into l_id, l_hash
18:             from "bk_block"
19:             where "seq" in (
20:                select max("seq") from "bk_block"
21:             ) ;
22:          NEW.prev_block_id = l_id;
23:          NEW.prev_block_hash = l_hash;
24:       END IF;
25:       RETURN NEW;
26:     END IF;
27: END;
28: $$ LANGUAGE plpgsql;
29: 
30: CREATE TRIGGER bk_block_trigger
31:    BEFORE INSERT OR UPDATE OR DELETE ON bk_block
32:    FOR EACH ROW EXECUTE PROCEDURE bk_block_tg();
</pre>
</section>

<!-- 11 -->
<!-- code at this point - Trigger / Table / pub-sub / Go -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION send_notify_after_trig()
 2: RETURNS TRIGGER AS $body$
 3: declare
 4:   msg text;
 5: begin
 6:   msg = '{"Cmd":"LogEvent","Hash":'||to_json(NEW.hash_of_this)||'}';
 7:   PERFORM pg_notify('events',msg);
 8:   return NEW;
 9: end;
10: $body$ LANGUAGE plpgsql;
11: 
12: CREATE TRIGGER send_notify_after_tg
13: AFTER INSERT ON bk_block
14:     FOR EACH ROW EXECUTE PROCEDURE send_notify_after_trig();
</pre>
</section>

<!-- 13 -->
<section>
<pre style="font-size:14px;">
...
 1: listenForEventToOccure := func(l *pq.Listener) {
 2:   nth := 0
 3:   period := 50
 4:   for {
 5:     select {
 6:     case n := &lt;-l.Notify:
 7:       nth++
 9:       var pd PgData
10:       err := json.Unmarshal([]byte(n.Extra), &and;pd)
11:       if err != nil {
12:         fmt.Printf("err %s data [%s]\n", err, pd)
13:       }
14:       if (nth % period) == 0 {
15:          tx, err := ethLogEvent.IndexedEvent(gCfg.LogAddress, pd.Hash)
16:          if err != nil {
17:             fmt.Printf("err %s data -[%s]-\n", err, pd.Hash)
19:          } else {
19:             fmt.Printf("Success Tx: %s\n", godebug.SVarI(tx))
20:          }
21:       }
22:       fmt.Printf("%+v\n", pd)
23:     case &lt;-time.After(60 * time.Second):
24:       nth++
25:       fmt.Printf("No data received after 1 min, verify db. conn.\n")
26:       go func() {
27:         l.Ping()
29:       }()
29:     }
30:   }
31: }
32: 
33: pgConn := pq.NewListener(pgConnectString, 1*time.Second,
      time.Minute, logError)
34: err = pgConn.Listen("events")
...
</pre>
</section>

<!-- 14 -->
<section>
<pre style="font-size:14px;">
 1: // SPDX-License-Identifier: MIT
 2: pragma solidity &gt;=0.6.0 &lt;=0.9.0;
 3: 
 4: contract LogEvent {
 5:   address payable owner;
 6:   event AnEvent ( address indexed account, string msg );
 7: 
 8:   constructor() {
 9:     owner = payable(msg.sender);
10:   }
11: 
12:   modifier onlyOwner() {
13:     require( msg.sender == owner, "Sender not authorized.");
14:     _;
15:   }
16: 
17:   function IndexedEvent ( address _acct, string memory _msg )
18:     public returns ( bool )
19:   {
20:     emit AnEvent ( _acct, _msg );
21:     return (true);
22:   }
23: }
</pre>
</section>

<!-- 15 -->
<section>
<pre style="font-size:14px;">
 1: create table c_inventory_item (
 2:    id          uuid DEFAULT uuid_generate_v4() not null primary key,
 3:    item_id     text not null ,
 4:    item_count  int default 1 not null ,
 5:    user_id     uuid not null ,
 6:    created     timestamp default current_timestamp not null
 7: );
 8: 
 9: CREATE OR REPLACE FUNCTION notify_for_inventory_item()
10: RETURNS TRIGGER AS $$
11: declare
12:    msg text;
13: begin
14:    insert into bk_block ( data ) values ( row_to_json(NEW) );
15:    return NEW;
16: end;
17: $$ LANGUAGE plpgsql;
18: 
19: CREATE TRIGGER imutable_inventory_item_imutable
20: AFTER INSERT ON c_inventory_item
21:     FOR EACH ROW EXECUTE PROCEDURE notify_for_inventory_item();
22: 
23: CREATE OR REPLACE FUNCTION imutable_data()
24: RETURNS TRIGGER AS $$
25: begin
26:    return NULL;
27: end;
28: $$ LANGUAGE plpgsql;
29: 
30: CREATE TRIGGER notify_inventory_item_imutable
31: AFTER DELETE or UPDATE ON c_inventory_item
32:     FOR EACH ROW EXECUTE PROCEDURE imutable_data();
</pre>
</section>

<!-- 16 -->
<section>
	<h3> An Approach: Uses </h3>
	<ul>
		<li> Parole System </li>
		<li> ISO 9002 Documents </li>
		<li> Logging Files </li>
	</ul>
</section>

<!-- 17 -->
<section>
	<h3> An Approach: Why </h3>
	<ul>
		<li> Cost </li>
		<li> Throughput </li>
	</ul>
</section>


<!-- 18 -->
<section>
	<h3> An Approach: Better Proof </h3>
	<ul>
		<li> More Secure "hash"/"signature" </li>
		<li> Send to Secure Storage (Eth) </li>
	</ul>
</section>


<!-- =========================================================== Approach 2 =========================================================== -->

<!-- 19 -->
<section>
	<h3> Approach 2: Networked Nodes </h3>
	<ul>
		<li> Distributed Data </li>
		<li> Peru Mine </li>
		<li> Food Tracking </li>
	</ul>
</section>

<!-- 20 -->
<section>
	<h3> Approach 2: What is missing from PG </h3>
	<ul>
		<li> Sign/Verify </li>
		<li> P2P Communication </li>
		<li> HTTP(s) Server </li>
	</ul>
</section>

<!-- 21 -->
<section>
	<h3> Approach 2: Transactions </h3>
	<ul>
		<li> Berkley's Definity - 9 nodes </li>
		<li> Consensus 16 nodes picked randomly </li>
		<li> Consensus at (16/2) + 1 == 8+1 == 9 </li>
		<li> Phase 0 - Start Block </li>
		<li> Phase 1 - Share Transactions (P2P) </li>
		<li> Phase 2 - Pick set to run : Consensus </li>
		<li> Phase 3 - run set </li>
		<li> Phase 4 - Share end-block (P2P) Consensus </li>
	</ul>
</section>

<!-- https://lucid.app/lucidchart/02b34f19-9778-441b-94ac-05cc14231a27/edit?beaconFlowId=F8CA59A90B8E9624&page=0_0# -->
<!-- 22 -->
<section>
	<h3> An Approach: Model </h3>
	<img height="290" src="/img/erd.png">
</section>

<!-- 23 -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION bc_data_tg()
		RETURNS trigger AS $$
 2: DECLARE
 3:    l_seq_id bigint;
 4:    l_id text;
 5:    l_hash text;
 6: BEGIN
 7:     IF tg_op = 'UPDATE' or tg_op = 'DELETE' THEN
 8:       RAISE EXCEPTION 'Can not UPDATE or DELETE from '
			USING ERRCODE='20808';
 9:         RETURN NULL;   -- Prevent All Updtes/Deletes
10:     END IF;
11:     IF tg_op = 'INSERT' THEN
12:       NEW.hash_of_this = digest(NEW.data||<span class="red">NEW.merkle_hash</span>
			||NEW.prev_block_hash||(NEW.prev_block_id::text), 'sha256');
13:       IF new.id = 'e9d963e1-d2a2-4e35-8c37-22742008bce4'::uuid 
14:          and NEW.data = 'genesis row' THEN
15:          NEW.prev_block_hash = NEW.hash_of_this;
16:          NEW.prev_block_id = NEW.id;
17:       ELSE
18:          select  "id", "hash_of_this" into l_id, l_hash
19:             from "bc_block"
20:             where "seq" in ( 
21:                select max("seq") from "bc_block"
22:             ) ;
23:          NEW.prev_block_id = l_id;
24:          NEW.prev_block_hash = l_hash;
25:       END IF;
26:         RETURN NEW;
27:     END IF;
28: END;
29: $$ LANGUAGE plpgsql;
30: 
31: CREATE TRIGGER bc_data_trigger
32:    BEFORE INSERT OR UPDATE OR DELETE ON bc_block 
33:    FOR EACH ROW EXECUTE PROCEDURE bc_data_tg();
</pre>
</section>

<!-- 24 - Go Server -->
<!-- 24 -->
<section>
	<h3> Sending A Transaction </h3>
	<ul>
		<li> Send From, To, Amount, Signature, Memo </li>
	</ul>
	<pre style="font-size:14px;">
wget -o 'o1' -O 'o2' 'http://localhost:9191/tx-send?
	from=0x7e3aFEc048bC7be745d0fA0F5af97D3978C40E9A&\
	to=0x9d41e5938767466af28865e1c33071f1561d57a8&\
	sign=0x797a53a6886c5e0cd8e69e3ce43a041db49b86a403dcb3f751829eecd0cd48a41a41a7412cc61d58284bcec191ab4061e6f3de0a28fd71433da5367fac793d7e00&\
	memo=aMemo'

	</pre>
</section>

<!-- 25 -->
<section>
	<h3> P2P sharing/consensus </h3>
	<ul>
		<li> Transactions just get Shared </li>
		<li> Each nodes use a random assignment </li>
		<li> If assigned they wait for 9 of 16 to agree </li>
		<li> Then Run the Transactions </li>
	</ul>
</section>

<!-- 25 -->
<section>
	<h3> Processing Cycle </h3>
	<img style="height:410px;" src="./img/cycle.png">
</section>


<!-- 26 - Merkle Trees -->
<section>
	<h3> Merkle Trees  </h3>
	<img style="height:480px;position:relative;top:-50px;left:25px;" src="./img/File_Hash_Tree.svg">
</section>








<!-- 27 -->
<section>
	<h3> Summary of This Approach </h3>
	<ul>
		<li> 30x systems (10 local) </li>
		<li> 20x5 = $100 a month </li>
		<li> Latency about 10sec </li>
		<li> Throughput about 40 TPS </li>
	</ul>
</section>


<!-- 28 -->
<section>
	<h3> Total Code </h3>
	<ul>
		<li> Overall less than 1500 lines of code </li>
		<li> Thanks to lots of good work go/libp2p </li>
		<li> Reasonably complicated code </li>
	</ul>
</section>













<!-- =========================================================== Conclustion  =========================================================== -->

<!-- 0 -->
<section>
	<h3> Conclusion </h3>
	<ul>
		<li> Important to determine features that you need </li>
		<li> Cost of Transactions / Latency / Throughout </li>
		<li> Distributed Computing has Alternates </li>
	</ul>
</section>



<!-- =========================================================== Conclusion  =========================================================== -->

<!-- 0 done -->
<section>
	<h3> Future Directions </h3>
    <p>
		<ul>
			<li> Implement a shared random-number system </li>
			<li> Implement protected data for contracts </li>
		</ul>
	</p>
</section>






















<section>
	<h3> References </h3>
	<p style="font-size:10px;">
		<a href="https://github.com/Univ-Wyo-Education/postgresql-conference-apr20">Software at: https://github.com/Univ-Wyo-Education/postgresql-conference-apr20 </a><br>
	</p>
</section>




















<script>
var video = document.querySelector("#videoElement");

if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
      video.srcObject = stream;
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}
</script>

<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet'>

<style>
.small_li {
	font-size: 20px;
}
html, .view body { background-color: black; counter-reset: slideidx; }
body, .view section {
	background-color: white; border-radius: 12px;
	font-family: 'Oswald', arial, serif;
}

section, .view head > title {
	  font-size: 2rem;
}

.view section:after {
	counter-increment: slideidx;
	content: counter(slideidx, decimal-leading-zero);
	position: absolute; bottom: -80px; right: 100px;
	color: white;
}

.view head > title {
	color: white;
	text-align: center;
	margin: 1em 0 1em 0;
}

h1 {
	margin: 120px 0 30px 0;
	text-align: center;
	font-size: 5rem;
}

h2 {
	text-align: center;
}

section > h3 {
	margin: 50px 50px 40px 50px;
	border-bottom: 0.1px solid;
}

pre {
	overflow: hidden;
	font-size: 1.25rem;
	margin: 0 75px 0 75px;
	padding: 10px;
	border: 1px solid;
	font-weight: bold;
	background-color: #F7F7F7;
	width:80%
}

ul, ol {
	  margin: 40px 100px 0 100px;
}

li > ul, ol {
	  margin: 0 0 15px 50px;
	  list-style-image: none; /* in case parent list has some */
}

mark.next:not([active]) {
	visibility: visible; /* override the default behavior where next is hidden */
	background-color: inherit; /* and disable highlighting instead */
}

p {
	margin: 75px 75px 0 75px;
	font-size: 3rem;
}

table {
	margin: auto;
	font-size:2.5rem;
	text-align: center;
}

blockquote {
	height: 100%;
	background-color: black;
	color: white;
	font-size: 3.75rem;
	padding: 50px;
}
blockquote:before {
	content: open-quote;
}
blockquote:after {
	content: close-quote;
}

/* Figures are displayed full-page, with the caption
	 on top of the image/video */
figure {
	background-color: black;
	width: 100%;
	height: 100%;
}
figure > * {
	position: absolute;
}
figure > img, figure > video {
	width: 100%; height: 100%;
}
figcaption {
	margin: 70px;
	font-size: 3rem;
}

header {
	background-color: #F3F4F8;
	border-bottom: 1px solid #CCC;
}

footer {
	background-color: #F3F4F8;
	border-top: 1px solid #CCC;
	padding-bottom: 4px; /* remember progress bar */
}

section footer {
	padding: 10px;
}

/* Transition effect */
/* Feel free to change the transition effect for original
	 animations. See here:
	 https://developer.mozilla.org/en/CSS/CSS_transitions
	 How to use CSS3 Transitions: */
section {
	transition: left 400ms linear 0s;
}
.view section {
	transition: none;
}

.view section[aria-selected] {
	border: 5px red solid;
}

@media screen {
/* Before */
section { left: -150%; }
/* Now */
section[aria-selected] { left: 0; }
/* After */
section[aria-selected] ~ section { left: +150%; }
}

/* The progressbar, at the bottom of the slides, show the global
	 progress of the presentation. */
#progress-bar {
	height: 4px;
	background: #AAA;
}
</style>

<div id="progress-bar"></div>

<!-- Default Style -->
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
[role="note"] { display: none; }
html {
	font-size: 16px;
}
body {
	width: 800px; height: 600px;
	position: absolute; top: 50%; left: 50%;
	overflow: hidden;
	display: none;
}
.view body {
	position: static;
	margin: 0; padding: 0;
	width: 100%; height: 100%;
	display: inline-block;
	overflow: visible; overflow-x: hidden;
	/* undo SlideIt.onresize */
	transform: none !important;
}
.view head, .view head > title { display: block }
section {
	position: absolute;
	pointer-events: none;
	width: 100%; height: 100%;
}
.view section {
	pointer-events: auto;
	position: static;
	width: 800px; height: 600px;
	margin: -150px -200px;
	float: left;

	transform: scale(.4);
}
.view section > * { pointer-events: none; }
section[aria-selected] { pointer-events: auto; }
html { overflow: hidden; }
html.view { overflow: visible; }
body.loaded { display: block; }
.next:not([active]) {visibility: hidden; }
#progress-bar{
	bottom: 0;
	position: absolute;
	transition: width 400ms linear 0s;
}
.view #progress-bar {
	display: none;
}
header {
	text-align: right;
	position: absolute;
	top: 0;
	width: 100%;
}
footer {
	text-align: right;
	position: absolute;
	bottom: 0;
	width: 100%;
}
.view header { display: none; }
.view footer { display: none; }

@media print {
section {
	transition: none;
	transform: none;
	position: static;
	page-break-inside: avoid;
}
body { overflow: visible; }
#progress-bar{ display:none; }
}

/*
   **************************************
   Uncomment the following for 16:9 slides
   **************************************

  html { font-size: 12px; }
  body { height: 450px; }
  .view section {
    height: 450px;
    margin: -140px -200px;
    transform: scale(.3);
  }
*/
</style>

<script>
var SlideIt = {
	remoteWindows: [],
	idx: -1,
	step: 0,
	html: null,
	slides: null,
	progressBar : null,
	params: {
	  autoplay: "1"
	}
};

// style="top:375px;left:50px;"			- left bottom - slide 1 		
// style="top:365px;left:507px;"		- right - mid  - slide 2 		
// style="top:150px;left:507px;"		- right - mid  - slide 3 		
// style="top:365px;left:507px;"		- right - mid  - slide 4 		
// Indexed by aStep
var posVideo = [
	{ top:5000, left:5000 },		
	{ show: true , slide:"1",  top:375, left:50 },		
	{ show: true , slide:"2",  top:365, left:507 },	
	{ show: true , slide:"3",  top:365, left:507 },
	{ show: true , slide:"4",  top:365, left:507 },
	{ show: true , slide:"5",  top:365, left:507 },
	{ show: false, slide:"6",  top:365, left:507 },
	{ show: true , slide:"7",  top:365, left:507 },
	{ show: true , slide:"8",  top:365, left:507 },
	{ show: true , slide:"9",  top:365, left:507 },		// Code 0 - original block table
	{ show: false, slide:"10", top:365, left:507 },	// Code 1 - main trigger
	{ show: true , slide:"11", top:365, left:507 },	// Code 2 - pub/sub notification PG - sender.
	{ show: false, slide:"12", top:365, left:507 },	// Go snippet
	{ show: true , slide:"13", top:365, left:507 },	 // Solidity Contract
	{ show: false, slide:"14", top:365, left:507 },  // Usage of imutable - table 
	{ show: true , slide:"15", top:365, left:507 },

	{ show: true , slide:"16", top:365, left:507 },
	{ show: true , slide:"17", top:365, left:507 },
	{ show: true , slide:"18", top:365, left:507 },
	{ show: true , slide:"19", top:365, left:507 },
	{ show: false , slide:"20", top:365, left:507 },

	{ show: true , slide:"21", top:365, left:50 },	// ERD
	{ show: true , slide:"22", top:365, left:507 },	// 

	{ show: true , slide:"23", top:365, left:507 },
	{ show: true , slide:"24", top:365, left:507 },	 
	{ show: true , slide:"25", top:365, left:507 },	 // video

	{ show: false, slide:"26", top:65, left:507 },
	{ show: true , slide:"27", top:365, left:507 },	 // video
	{ show: true , slide:"18", top:365, left:507 },
	{ show: true , slide:"19", top:365, left:507 },
	{ show: true , slide:"20", top:365, left:507 },
	{ show: true , slide:"21", top:365, left:507 },
	{ show: true , slide:"22", top:365, left:507 },
	{ show: true , slide:"23", top:365, left:507 },	
	{ show: true , slide:"24", top:365, left:507 },		// NONE!
	{ show: true , slide:"25", top:365, left:507 },		// NONE!

	{ show: false, slide:"19"  },
];

SlideIt.setVideo = function(aIdx) { 
	var iIdx = aIdx;
	console.log ( "aIdx = ", aIdx );
	iIdx = ( iIdx <= 0 || typeof iIdx == "undefined" ) ? 1 : iIdx;
	iIdx = parseInt ( iIdx );
	console.log ( "iIdx = ", iIdx );
	var v = ( iIdx < posVideo.length ) ? posVideo[iIdx] : { "show": false };
	console.log ( "v = ", v );
	if ( v.show ) {
		console.log ( "Use it - show it" );
		this.videoBox.style.top = v.top + "px";
		this.videoBox.style.left = v.left + "px";
		// this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
	} else {
		console.log ( "hide it" );
		this.videoBox.style.top = "5000px";
		this.videoBox.style.left = "5000px";
	}
}

SlideIt.init = function() {
	document.body.className = "loaded";
	this.slides = Array.prototype.slice.call($$("body > section"));
	this.progressBar = $("#progress-bar");
	this.html = document.body.parentNode;
	this.setupParams();
	this.onhashchange();
	this.setupTouchEvents();
	this.onresize();
	this.setupView();
	this.videoBox = $("#container");

	// xyzzy - init do position of video (1)
	var cursor = window.location.hash.split("#"),
	    newidx = 1;
	if (cursor.length == 2) {
	  newidx = ~~cursor[1].split(".")[0];
	  SlideIt.setVideo(newidx);
	} else {
	  SlideIt.setVideo("1");
	}
}

SlideIt.setupParams = function() {
	var p = window.location.search.substr(1).split('&');
	p.forEach(function(e, i, a) {
	  var keyVal = e.split('=');
	  SlideIt.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
	});
// Specific params handling
	if (!+this.params.autoplay)
	  $$.forEach($$("video"), function(v){ v.controls = true });
}

SlideIt.onkeydown = function(aEvent) {
	// Don't intercept keyboard shortcuts
	if (aEvent.altKey
	  || aEvent.ctrlKey
	  || aEvent.metaKey
	  || aEvent.shiftKey) {
	  return;
	}
	if ( aEvent.keyCode == 37 // left arrow
	  || aEvent.keyCode == 38 // up arrow
	  || aEvent.keyCode == 33 // page up
	) {
	  aEvent.preventDefault();
	  this.back();
	}
	if ( aEvent.keyCode == 39 // right arrow
	  || aEvent.keyCode == 40 // down arrow
	  || aEvent.keyCode == 34 // page down
	) {
	  aEvent.preventDefault();
	  this.forward();
	}
	if (aEvent.keyCode == 35) { // end
	  aEvent.preventDefault();
	  this.goEnd();
	}
	if (aEvent.keyCode == 36) { // home
	  aEvent.preventDefault();
	  this.goStart();
	}
	if (aEvent.keyCode == 32) { // space
	  aEvent.preventDefault();
	  this.toggleContent();
	}
	if (aEvent.keyCode == 70) { // f
	  aEvent.preventDefault();
	  this.goFullscreen();
	}
	if (aEvent.keyCode == 79    //o
	 || aEvent.keyCode == 27    //Esc
	) {
	  aEvent.preventDefault();
	  this.toggleView();
	}
}

/* Touch Events */

SlideIt.setupTouchEvents = function() {
	var orgX, newX;
	var tracking = false;

	var db = document.body;
	db.addEventListener("touchstart", start.bind(this), false);
	db.addEventListener("touchmove", move.bind(this), false);

	function start(aEvent) {
	  aEvent.preventDefault();
	  tracking = true;
	  orgX = aEvent.changedTouches[0].pageX;
	}

	function move(aEvent) {
	  if (!tracking) return;
	  newX = aEvent.changedTouches[0].pageX;
	  if (orgX - newX > 100) {
	    tracking = false;
	    this.forward();
	  } else {
	    if (orgX - newX < -100) {
	      tracking = false;
	      this.back();
	    }
	  }
	}
}

SlideIt.setupView = function() {
	document.body.addEventListener("click", function ( e ) {
	  if (!SlideIt.html.classList.contains("view")) return;
	  if (!e.target || e.target.nodeName != "SECTION") return;

	  SlideIt.html.classList.remove("view");
	  SlideIt.setCursor(SlideIt.slides.indexOf(e.target) + 1);
	}, false);
}

/* Adapt the size of the slides to the window */

SlideIt.onresize = function() {
	var db = document.body;
	var sx = db.clientWidth / window.innerWidth;
	var sy = db.clientHeight / window.innerHeight;
	var transform = "scale(" + (1/Math.max(sx, sy)) + ")";
	db.style.transform = transform;
	db.style.marginTop = -db.clientHeight / 2 + "px";
	db.style.marginLeft = -db.clientWidth / 2 + "px";
}


SlideIt.getNotes = function(aIdx) {
	var s = $("section:nth-of-type(" + aIdx + ")");
	var d = s.$("[role='note']");
	return d ? d.innerHTML : "";
}

SlideIt.onmessage = function(aEvent) {
	var argv = aEvent.data.split(" "), argc = argv.length;
	argv.forEach(function(e, i, a) { a[i] = decodeURIComponent(e) });
	var win = aEvent.source;
	if (argv[0] === "REGISTER" && argc === 1) {
	  this.remoteWindows.push(win);
	  this.postMsg(win, "REGISTERED", document.title, this.slides.length);
	  this.postMsg(win, "CURSOR", this.idx + "." + this.step);
	  return;
	}
	if (argv[0] === "BACK" && argc === 1)
	  this.back();
	if (argv[0] === "FORWARD" && argc === 1)
	  this.forward();
	if (argv[0] === "START" && argc === 1)
	  this.goStart();
	if (argv[0] === "END" && argc === 1)
	  this.goEnd();
	if (argv[0] === "TOGGLE_CONTENT" && argc === 1)
	  this.toggleContent();
	if (argv[0] === "SET_CURSOR" && argc === 2)
	  window.location.hash = "#" + argv[1];
	if (argv[0] === "GET_CURSOR" && argc === 1)
	  this.postMsg(win, "CURSOR", this.idx + "." + this.step);
	if (argv[0] === "GET_NOTES" && argc === 1)
	  this.postMsg(win, "NOTES", this.getNotes(this.idx));
}

SlideIt.toggleContent = function() {
	// If a Video is present in this new slide, play it.
	// If a Video is present in the previous slide, stop it.
	var s = $("section[aria-selected]");
	if (s) {
	  var video = s.$("video");
	  if (video) {
	    if (video.ended || video.paused) {
	      video.play();
	    } else {
	      video.pause();
	    }
	  }
	}
}

//SlideIt.setVideo = function(aIdx) { 
//	var iIdx = aIdx;
//	console.log ( "aIdx = ", aIdx );
//	iIdx = ( iIdx <= 0 || typeof iIdx == "undefined" ) ? 1 : iIdx;
//	iIdx = parseInt ( iIdx );
//	console.log ( "iIdx = ", iIdx );
//	var v = posVideo[iIdx];
//	console.log ( "v = ", v );
//	if ( v.show ) {
//		console.log ( "Use it - show it" );
//		this.videoBox.style.top = v.top + "px";
//		this.videoBox.style.left = v.left + "px";
//		// this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
//	} else {
//		console.log ( "hide it" );
//		this.videoBox.style.top = "5000px";
//		this.videoBox.style.left = "5000px";
//	}
//}

SlideIt.setCursor = function(aIdx, aStep) {
	SlideIt.setVideo ( aIdx ); 
	// If the user change the slide number in the URL bar, jump
	// to this slide.
	aStep = (aStep != 0 && typeof aStep !== "undefined") ? "." + aStep : ".0";
	window.location.hash = "#" + aIdx + aStep;
}

SlideIt.onhashchange = function() {
	var cursor = window.location.hash.split("#"),
	    newidx = 1,
	    newstep = 0;
	if (cursor.length == 2) {
	  newidx = ~~cursor[1].split(".")[0];
	  newstep = ~~cursor[1].split(".")[1];
	  if (newstep > SlideIt.slides[newidx - 1].$$('.next').length) {
	    newstep = 0;
	    newidx++;
	  }
	}
	this.setProgress(newidx, newstep);
	if (newidx != this.idx) {
	  this.setSlide(newidx);
	}
	if (newstep != this.step) {
	  this.setIncremental(newstep);
	}
	for (var i = 0; i < this.remoteWindows.length; i++) {
	  this.postMsg(this.remoteWindows[i], "CURSOR", this.idx + "." + this.step);
	}
}

SlideIt.back = function() {
	if (this.idx == 1) {
	  return;
	}
	this.setCursor(this.idx - 1, this.slides[this.idx - 2].$$('.next[active]').length);
}

SlideIt.forward = function() {
	if (this.idx >= this.slides.length &&
	    this.step >= this.slides[this.idx - 1].$$('.next').length) {
	    return;
	}
	if (this.html.classList.contains("view") ||
	    this.step >= this.slides[this.idx - 1].$$('.next').length) {
	  this.setCursor(this.idx + 1,
	                 this.slides[this.idx].$$('.next[active]').length);
	} else {
	  this.setCursor(this.idx, this.step + 1);
	}
}

SlideIt.goStart = function() {
	this.setCursor(1, 0);
}

SlideIt.goEnd = function() {
	var lastIdx = this.slides.length;
	var lastStep = this.slides[lastIdx - 1].$$('.next').length;
	this.setCursor(lastIdx, lastStep);
}

SlideIt.toggleView = function() {
	this.html.classList.toggle("view");

	if (this.html.classList.contains("view")) {
	  $("section[aria-selected]").scrollIntoView(true);
	}
}

SlideIt.setSlide = function(aIdx) {
	this.idx = aIdx;
	var old = $("section[aria-selected]");
	var next = $("section:nth-of-type("+ this.idx +")");
	if (old) {
	  old.removeAttribute("aria-selected");
	  var video = old.$("video");
	  if (video) {
	    video.pause();
	  }
	}
	if (next) {
	  next.setAttribute("aria-selected", "true");
	  if (this.html.classList.contains("view")) {
	    next.scrollIntoView();
	  } else {
	    var video = next.$("video");
	    if (video && !!+this.params.autoplay) {
	      video.play();
	    }
	  }
	} else {
	  // That should not happen
	  this.idx = -1;
	  // console.warn("Slide doesn't exist.");
	}
}

SlideIt.setIncremental = function(aStep) {
	this.step = aStep;
	var incrementals = Array.prototype.slice.call(this.slides[this.idx - 1].$$('.next')).sort(function(a, b) {
	        return Number(a.getAttribute('next-order')) - Number(b.getAttribute('next-order'));
	      });
	var next = incrementals[this.step - 1];
	if (next) {
	  next.setAttribute('active', true);
	} else {
	  this.setCursor(this.idx, 0);
	}
	return next;
}

SlideIt.goFullscreen = function() {
	var html = $('html'),
	    requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
	if (requestFullscreen) {
	  requestFullscreen.apply(html);
	}
}

SlideIt.setProgress = function(aIdx, aStep) {
	var slide = $("section:nth-of-type("+ aIdx +")");
	if (!slide)
	  return;
	var steps = slide.$$('.next').length + 1,
	    slideSize = 100 / (this.slides.length - 1),
	    stepSize = slideSize / steps;
	this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
}

SlideIt.postMsg = function(aWin, aMsg) { // [arg0, [arg1...]]
	aMsg = [aMsg];
	for (var i = 2; i < arguments.length; i++)
	  aMsg.push(encodeURIComponent(arguments[i]));
	aWin.postMessage(aMsg.join(" "), "*");
}

function init() {
	SlideIt.init();
	window.onkeydown = SlideIt.onkeydown.bind(SlideIt);
	window.onresize = SlideIt.onresize.bind(SlideIt);
	window.onhashchange = SlideIt.onhashchange.bind(SlideIt);
	window.onmessage = SlideIt.onmessage.bind(SlideIt);
}

window.onload = init;

// Helpers
if (!Function.prototype.bind) {
	Function.prototype.bind = function (oThis) {

	  // closest thing possible to the ECMAScript 5 internal IsCallable
	  // function 
	  if (typeof this !== "function")
	  throw new TypeError(
	    "Function.prototype.bind - what is trying to be fBound is not callable"
	  );

	  var aArgs = Array.prototype.slice.call(arguments, 1),
	      fToBind = this,
	      fNOP = function () {},
	      fBound = function () {
	        return fToBind.apply( this instanceof fNOP ? this : oThis || window,
	               aArgs.concat(Array.prototype.slice.call(arguments)));
	      };

	  fNOP.prototype = this.prototype;
	  fBound.prototype = new fNOP();

	  return fBound;
	};
}

var $ = (HTMLElement.prototype.$ = function(aQuery) {
	return this.querySelector(aQuery);
}).bind(document);

var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
	return this.querySelectorAll(aQuery);
}).bind(document);

$$.forEach = function(nodeList, fun) {
	Array.prototype.forEach.call(nodeList, fun);
}

</script>

</body>
</html>

<!--

Copyrigyht (C) University of Wyoming, 2021.
By Prof Philip Schlump.

=========================================================================

-->


<link href="https://vjs.zencdn.net/7.10.2/video-js.css" rel="stylesheet" />
<!-- If you'd like to support IE8 (for Video.js versions prior to v7) -->
<script src="https://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script>
<style>
.video-js {
	width: 100%;
	height: 678px;
}
</style>



<!-- This is the first slide -->

<section>
    <h2 style="padding-top:80px;" >  Building Blockchain inside PostgreSQL </h2>
	<div style="width:100%">
		<img style="padding-left:70px;float-left;padding-top:20px;" height="150" src="img/logo_mod.png">
	</div>
    <footer>
			PostgreSQL International Conference <br>
			Prof. Philip Schlump <br>
           University of Wyoming <br>
           Department of Computer Science <br>
		   Tue Apr 20, 2021 <br>
	 </footer>
</section>

<!-- 2 -->
<section>
	<p>
		<ol>
			<li> Overview </li>
			<li> What is a blockchian. </li>
			<li> An approach Simple Signed proof of Immutable Data </li>
			<li> Proof of Signature. </li>
			<li> Shared Data (multi-node). </li>
			<li> Where our current efforts are at. </li>
		<ol>
	</p>
</section>


<!-- 3 -->
<section>
	<h3> Overview : What is a Blockchain </h3>
		<ul>
			<li> What is a blockchain? </li>
			<li> All the hype </li>
			<li> Underling system below cryptocurrencies </li>
			<li> Used for the transfer of assets: NFTs </li>
			<li> What can it really do? </li>
		</ul>
</section>

<!-- 4 -->
<section>
	<h3> Overview : Useful Features of Blockchain </h3>
		<ul>
			<li> Immutable Data </li>
			<li> Shared Data </li>
		</ul>
</section>

<!-- 5 -->
<section>
	<h3> Overview : Kinds of Blockchains </h3>
		<ul>
			<li> Private </li>
			<li> Permissioned </li>
			<li> Public </li>
		</ul>
</section>

<!-- 6 -->
<section>
	<h3> Overview : Consensus </h3>
		<ul>
			<li> 1st Generation Consensus: Proof of Work Bitcoin, Eth v.1.x </li>
			<li> 2nd Gen. Proof of Stake: Cardano., Eth v.2.x </li>
			<li> 2nd Gen. Proof of Authority: This presentation today </li>
			<li> 3rd Gen. Honey-Badger BFT, Difinity (Berkley) </li>
		</ul>
</section>

<!-- 7 -->
<section>
	<h3> Overview : Why a Blockchain Matters </h3>
		<ul>
			<li> Secure Transfer of Tokens and Ownership </li>
			<li> Strong Authentication </li>
		</ul>
</section>

<!-- =========================================================== Approach 1 =========================================================== -->

<!-- 8 -->
<section>
	<h3> An Approach: Requirements (single node) </h3>
		<ul>
			<li> Post data </li>
			<li> Immutable Data </li>
			<li> Triggers + Hash </li>
		</ul>
</section>

<!-- 9 -->
<!-- code at this point - Trigger / Table / pub-sub / Go -->
<section>
<pre style="font-size:14px;">
 1: CREATE TABLE bk_block (
 2:     id                uuid DEFAULT uuid_generate_v4() not null
                             primary key,
 3:     seq               serial not null,
 4:     data              text not null,
 5:     hash_of_this      text not null,
 6:     prev_block_hash   text default '*' not null,
 7:     prev_block_id     uuid not null,
 8:     created           timestamp default current_timestamp not null
 9: );
10: 
11: create unique index bk_block_u1 on bk_block ( hash_of_this );
12: create index bk_block_p1 on bk_block ( created );
13: create index bk_block_p2 on bk_block ( prev_block_id );
14: create index bk_block_p3 on bk_block ( prev_block_hash );
</pre>
</section>

<!-- 10 -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION bk_block_tg() RETURNS trigger AS $$
 2: DECLARE
 3:    l_seq_id bigint;
 4:    l_id text;
 5:    l_hash text;
 6: BEGIN
 7:     IF tg_op = 'UPDATE' or tg_op = 'DELETE' THEN
 8:       RAISE EXCEPTION 'Can not UPDATE or DELETE from '
              USING ERRCODE='20808';
 9:         RETURN NULL;   -- Prevent All Updtes/Deletes
10:     ELSIF tg_op = 'INSERT' THEN
11:       NEW.hash_of_this = digest(CONCAT(NEW.data,
             NEW.prev_block_hash,NEW.hash_of_this,
             (NEW.prev_block_id::text)), 'sha256');
12:       IF new.id = 'e9d963e1-d2a2-4e35-8c37-22742008bce4'::uuid
13:          and NEW.data = 'genesis row' THEN
14:          NEW.prev_block_hash = NEW.hash_of_this;
15:          NEW.prev_block_id = NEW.id;
16:       ELSE
17:          select  "id", "hash_of_this" into l_id, l_hash
18:             from "bk_block"
19:             where "seq" in (
20:                select max("seq") from "bk_block"
21:             ) ;
22:          NEW.prev_block_id = l_id;
23:          NEW.prev_block_hash = l_hash;
24:       END IF;
25:       RETURN NEW;
26:     END IF;
27: END;
28: $$ LANGUAGE plpgsql;
29: 
30: CREATE TRIGGER bk_block_trigger
31:    BEFORE INSERT OR UPDATE OR DELETE ON bk_block
32:    FOR EACH ROW EXECUTE PROCEDURE bk_block_tg();
</pre>
</section>

<!-- 11 -->
<!-- code at this point - Trigger / Table / pub-sub / Go -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION send_notify_after_trig()
 2: RETURNS TRIGGER AS $body$
 3: declare
 4:   msg text;
 5: begin
 6:   msg = '{"Cmd":"LogEvent","Hash":'||to_json(NEW.hash_of_this)||'}';
 7:   PERFORM pg_notify('events',msg);
 8:   return NEW;
 9: end;
10: $body$ LANGUAGE plpgsql;
11: 
12: CREATE TRIGGER send_notify_after_tg
13: AFTER INSERT ON bk_block
14:     FOR EACH ROW EXECUTE PROCEDURE send_notify_after_trig();
</pre>
</section>

<!-- 13 -->
<section>
<pre style="font-size:14px;">
...
 1: listenForEventToOccure := func(l *pq.Listener) {
 2:   nth := 0
 3:   period := 50
 4:   for {
 5:     select {
 6:     case n := &lt;-l.Notify:
 7:       nth++
 9:       var pd PgData
10:       err := json.Unmarshal([]byte(n.Extra), &and;pd)
11:       if err != nil {
12:         fmt.Printf("err %s data [%s]\n", err, pd)
13:       }
14:       if (nth % period) == 0 {
15:          tx, err := ethLogEvent.IndexedEvent(gCfg.LogAddress, pd.Hash)
16:          if err != nil {
17:             fmt.Printf("err %s data -[%s]-\n", err, pd.Hash)
19:          } else {
19:             fmt.Printf("Success Tx: %s\n", godebug.SVarI(tx))
20:          }
21:       }
22:       fmt.Printf("%+v\n", pd)
23:     case &lt;-time.After(60 * time.Second):
24:       nth++
25:       fmt.Printf("No data received after 1 min, verify db. conn.\n")
26:       go func() {
27:         l.Ping()
29:       }()
29:     }
30:   }
31: }
32: 
33: pgConn := pq.NewListener(pgConnectString, 1*time.Second,
      time.Minute, logError)
34: err = pgConn.Listen("events")
...
</pre>
</section>

<!-- 14 -->
<section>
<pre style="font-size:14px;">
 1: // SPDX-License-Identifier: MIT
 2: pragma solidity &gt;=0.6.0 &lt;=0.9.0;
 3: 
 4: contract LogEvent {
 5:   address payable owner;
 6:   event AnEvent ( address indexed account, string msg );
 7: 
 8:   constructor() {
 9:     owner = payable(msg.sender);
10:   }
11: 
12:   modifier onlyOwner() {
13:     require( msg.sender == owner, "Sender not authorized.");
14:     _;
15:   }
16: 
17:   function IndexedEvent ( address _acct, string memory _msg )
18:     public returns ( bool )
19:   {
20:     emit AnEvent ( _acct, _msg );
21:     return (true);
22:   }
23: }
</pre>
</section>

<!-- 15 -->
<section>
<pre style="font-size:14px;">
 1: create table c_inventory_item (
 2:    id          uuid DEFAULT uuid_generate_v4() not null primary key,
 3:    item_id     text not null ,
 4:    item_count  int default 1 not null ,
 5:    user_id     uuid not null ,
 6:    created     timestamp default current_timestamp not null
 7: );
 8: 
 9: CREATE OR REPLACE FUNCTION notify_for_inventory_item()
10: RETURNS TRIGGER AS $$
11: declare
12:    msg text;
13: begin
14:    insert into bk_block ( data ) values ( row_to_json(NEW) );
15:    return NEW;
16: end;
17: $$ LANGUAGE plpgsql;
18: 
19: CREATE TRIGGER imutable_inventory_item_imutable
20: AFTER INSERT ON c_inventory_item
21:     FOR EACH ROW EXECUTE PROCEDURE notify_for_inventory_item();
22: 
23: CREATE OR REPLACE FUNCTION imutable_data()
24: RETURNS TRIGGER AS $$
25: begin
26:    return NULL;
27: end;
28: $$ LANGUAGE plpgsql;
29: 
30: CREATE TRIGGER notify_inventory_item_imutable
31: AFTER DELETE or UPDATE ON c_inventory_item
32:     FOR EACH ROW EXECUTE PROCEDURE imutable_data();
</pre>
</section>

<!-- 16 -->
<section>
	<h3> An Approach: Uses </h3>
	<ul>
		<li> Parole System </li>
		<li> ISO 9002 Documents </li>
		<li> Logging Files </li>
	</ul>
</section>

<!-- 17 -->
<section>
	<h3> An Approach: Why </h3>
	<ul>
		<li> Cost </li>
		<li> Throughput </li>
	</ul>
</section>


<!-- 18 -->
<section>
	<h3> An Approach: Better Proof </h3>
	<ul>
		<li> More Secure "hash"/"signature" </li>
		<li> Send to Secure Storage (Eth) </li>
	</ul>
</section>


<!-- =========================================================== Approach 2 =========================================================== -->

<!-- 19 -->
<section>
	<h3> Approach 2: Networked Nodes </h3>
	<ul>
		<li> Distributed Data </li>
		<li> Peru Mine </li>
		<li> Food Tracking </li>
	</ul>
</section>

<!-- 20 -->
<section>
	<h3> Approach 2: What is missing from PG </h3>
	<ul>
		<li> Sign/Verify </li>
		<li> P2P Communication </li>
		<li> HTTP(s) Server </li>
	</ul>
</section>

<!-- 21 -->
<section>
	<h3> Approach 2: Transactions </h3>
	<ul>
		<li> Berkley's Definity - 9 nodes </li>
		<li> Consensus 16 nodes picked randomly </li>
		<li> Consensus at (16/2) + 1 == 8+1 == 9 </li>
		<li> Phase 0 - Start Block </li>
		<li> Phase 1 - Share Transactions (P2P) </li>
		<li> Phase 2 - Pick set to run : Consensus </li>
		<li> Phase 3 - run set </li>
		<li> Phase 4 - Share end-block (P2P) Consensus </li>
	</ul>
</section>

<!-- https://lucid.app/lucidchart/02b34f19-9778-441b-94ac-05cc14231a27/edit?beaconFlowId=F8CA59A90B8E9624&page=0_0# -->
<!-- 22 -->
<section>
	<h3> An Approach: Model </h3>
	<img height="290" src="/img/erd.png">
</section>

<!-- 23 -->
<section>
<pre style="font-size:14px;">
 1: CREATE OR REPLACE FUNCTION bc_data_tg()
		RETURNS trigger AS $$
 2: DECLARE
 3:    l_seq_id bigint;
 4:    l_id text;
 5:    l_hash text;
 6: BEGIN
 7:     IF tg_op = 'UPDATE' or tg_op = 'DELETE' THEN
 8:       RAISE EXCEPTION 'Can not UPDATE or DELETE from '
			USING ERRCODE='20808';
 9:         RETURN NULL;   -- Prevent All Updtes/Deletes
10:     END IF;
11:     IF tg_op = 'INSERT' THEN
12:       NEW.hash_of_this = digest(NEW.data||<span class="red">NEW.merkle_hash</span>
			||NEW.prev_block_hash||(NEW.prev_block_id::text), 'sha256');
13:       IF new.id = 'e9d963e1-d2a2-4e35-8c37-22742008bce4'::uuid 
14:          and NEW.data = 'genesis row' THEN
15:          NEW.prev_block_hash = NEW.hash_of_this;
16:          NEW.prev_block_id = NEW.id;
17:       ELSE
18:          select  "id", "hash_of_this" into l_id, l_hash
19:             from "bc_block"
20:             where "seq" in ( 
21:                select max("seq") from "bc_block"
22:             ) ;
23:          NEW.prev_block_id = l_id;
24:          NEW.prev_block_hash = l_hash;
25:       END IF;
26:         RETURN NEW;
27:     END IF;
28: END;
29: $$ LANGUAGE plpgsql;
30: 
31: CREATE TRIGGER bc_data_trigger
32:    BEFORE INSERT OR UPDATE OR DELETE ON bc_block 
33:    FOR EACH ROW EXECUTE PROCEDURE bc_data_tg();
</pre>
</section>

<!-- 24 - Go Server -->
<!-- 24 -->
<section>
	<h3> Sending A Transaction </h3>
	<ul>
		<li> Send From, To, Amount, Signature, Memo </li>
	</ul>
	<pre style="font-size:14px;">
wget -o 'o1' -O 'o2' 'http://localhost:9191/tx-send?
	from=0x7e3aFEc048bC7be745d0fA0F5af97D3978C40E9A&\
	to=0x9d41e5938767466af28865e1c33071f1561d57a8&\
	sign=0x797a53a6886c5e0cd8e69e3ce43a041db49b86a403dcb3f751829eecd0cd48a41a41a7412cc61d58284bcec191ab4061e6f3de0a28fd71433da5367fac793d7e00&\
	memo=aMemo'

	</pre>
</section>

<!-- 25 -->
<section>
	<h3> P2P sharing/consensus </h3>
	<ul>
		<li> Transactions just get Shared </li>
		<li> Each nodes use a random assignment </li>
		<li> If assigned they wait for 9 of 16 to agree </li>
		<li> Then Run the Transactions </li>
	</ul>
</section>

<!-- 25 -->
<section>
	<h3> Processing Cycle </h3>
	<img style="height:410px;" src="./img/cycle.png">
</section>


<!-- 26 - Merkle Trees -->
<section>
	<h3> Merkle Trees  </h3>
	<img style="height:480px;position:relative;top:-50px;left:25px;" src="./img/File_Hash_Tree.svg">
</section>








<!-- 27 -->
<section>
	<h3> Summary of This Approach </h3>
	<ul>
		<li> 30x systems (10 local) </li>
		<li> 20x5 = $100 a month </li>
		<li> Latency about 10sec </li>
		<li> Throughput about 40 TPS </li>
	</ul>
</section>


<!-- 28 -->
<section>
	<h3> Total Code </h3>
	<ul>
		<li> Overall less than 1500 lines of code </li>
		<li> Thanks to lots of good work go/libp2p </li>
		<li> Reasonably complicated code </li>
	</ul>
</section>













<!-- =========================================================== Conclustion  =========================================================== -->

<!-- 0 -->
<section>
	<h3> Conclusion </h3>
	<ul>
		<li> Important to determine features that you need </li>
		<li> Cost of Transactions / Latency / Throughout </li>
		<li> Distributed Computing has Alternates </li>
	</ul>
</section>



<!-- =========================================================== Conclusion  =========================================================== -->

<!-- 0 done -->
<section>
	<h3> Future Directions </h3>
    <p>
		<ul>
			<li> Implement a shared random-number system </li>
			<li> Implement protected data for contracts </li>
		</ul>
	</p>
</section>






















<section>
	<h3> References </h3>
	<p style="font-size:10px;">
		<a href="https://github.com/Univ-Wyo-Education/postgresql-conference-apr20">Software at: https://github.com/Univ-Wyo-Education/postgresql-conference-apr20 </a><br>
	</p>
</section>




